name: Deploy Bot (Clean)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: mishadeploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30m
          script: |
            set -e
            
            echo "=== –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ==="
            pkill -f "python3 mishakrug.py" || echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            sleep 2
            
            echo "=== –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ==="
            cd /opt
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º .env –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -f "mishakrug_tg_bot/.env" ]; then
              echo "–°–æ—Ö—Ä–∞–Ω—è–µ–º .env —Ñ–∞–π–ª..."
              cp mishakrug_tg_bot/.env /tmp/mishakrug_env_backup
            fi
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º venv –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -d "mishakrug_tg_bot/venv" ]; then
              echo "–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              cp -r mishakrug_tg_bot/venv /tmp/mishakrug_venv_backup
            fi
            
            echo "=== –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ ==="
            rm -rf mishakrug_tg_bot
            
            echo "=== –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ==="
            git clone https://github.com/devilcrowley/mishakrug_tg_bot.git
            cd mishakrug_tg_bot
            
            echo "=== –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ==="
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env
            if [ -f "/tmp/mishakrug_env_backup" ]; then
              echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env —Ñ–∞–π–ª..."
              cp /tmp/mishakrug_env_backup .env
              rm /tmp/mishakrug_env_backup
            fi
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º venv
            if [ -d "/tmp/mishakrug_venv_backup" ]; then
              echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              cp -r /tmp/mishakrug_venv_backup venv
              rm -rf /tmp/mishakrug_venv_backup
            else
              echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
              python3 -m venv venv
            fi
            
            echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ==="
            source venv/bin/activate
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            fi
            
            echo "=== –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ==="
            nohup python3 mishakrug.py > mishakrug.log 2>&1 &
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ ==="
            sleep 3
            if pgrep -f "python3 mishakrug.py" > /dev/null; then
              echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              echo "PID: $(pgrep -f 'python3 mishakrug.py')"
            else
              echo "‚ùå –û–®–ò–ë–ö–ê: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
              echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
              tail -10 mishakrug.log || echo "–õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
